---
title: "Exploratory Data Analysis of Loan Eligibility Data Set"
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
author: "Jake Bersabe"
date: "15/11/2021"
output: html_document
---

Import data set and libraries:   
```{r message=FALSE}
library(dplyr)
library(skimr)

data <- readr::read_csv("train.csv")
glimpse(data)
skim(data)
```



```{r}

# Function to add monthly income column
monthly_payment <- function(loan_amount, loan_amount_term){
  r <- 0.005
  monthly_payment <- (loan_amount/(((1+r)^loan_amount_term)-1))*(((1+r)^loan_amount_term)*r)
  return(monthly_payment)
} 

# Pre-processing pipeline 

data_preprocessed <- data %>%
  mutate(LoanAmount = LoanAmount*1000,
         CombinedIncome = ApplicantIncome + CoapplicantIncome) %>% 
  #select(-ApplicantIncome, -CoapplicantIncome) %>% 
  mutate(MonthlyPayment = monthly_payment(LoanAmount, Loan_Amount_Term),
         PaymentIncomeRatio = MonthlyPayment/CombinedIncome)
  
glimpse(data_preprocessed)
```

### 1. Is there a difference between the median income of applicants with approved loan status and applicants with rejected loan status?   
```{r}
data_preprocessed %>% 
  group_by(Loan_Status) %>% 
  summarise(Count = n(), MedianIncome = median(ApplicantIncome))
```

>Surprisingly, *applicants who are ineligible for loan have higher average income* than eligible applicants.   

### 2. Do applicants with less payment-to-income ratio more likely to be eligible for loan?  
```{r warning=FALSE}
library(ggplot2)
data_preprocessed %>% 
  ggplot(aes(PaymentIncomeRatio, fill = Loan_Status))+
  geom_density(alpha  = 0.4)
```


```{r}
data_preprocessed %>% 
  filter(PaymentIncomeRatio != "") %>% 
  group_by(Loan_Status) %>% 
  summarise(Count = n(), MeanPayIncomeRatio = mean(PaymentIncomeRatio, na.rm=T))
```

>Eligible applicants have lower mean of payment-to-income ratio; however, this is not accurate since there are outliers in the data. Median would be the more appropriate measurement to use.  

```{r}
data_preprocessed %>% 
  filter(PaymentIncomeRatio != "") %>% 
  group_by(Loan_Status) %>% 
  summarise(Count = n(), MedianPayIncomeRatio = median(PaymentIncomeRatio, na.rm=T))
```

There is not much difference in medians between the two groups.   


### 3. Is there a difference in the income of applicants who graduated and those who did not?  
```{r}
library(ggplot2)

data_preprocessed %>% 
  ggplot(aes(x = (ApplicantIncome), fill = Education))+
  geom_density(alpha = 0.5)

data_preprocessed %>% 
  ggplot(aes(x = log(ApplicantIncome), fill = Education))+
  geom_density(alpha = 0.5)

```

>The median for the income of both groups are approximately the same.  

### 4. Do self-employed applicants have lower income?  
```{r}
data_preprocessed %>% 
  filter(Self_Employed != "") %>% 
  ggplot(aes(ApplicantIncome, fill = Self_Employed))+
  geom_density(alpha  = 0.5)
```

```{r}
data_preprocessed %>% 
  filter(Self_Employed != "") %>% 
  group_by(Self_Employed) %>% 
  summarise(Count = n(), MedianApplicantIncome = median(ApplicantIncome))
```

>Self-employed applicants actually have higher median income.  

### 5. Are applicants with low monthly payment more likely to be eligible for loan?   
```{r}
data_preprocessed %>% 
  group_by(Loan_Status) %>% 
  summarise(Count = n(), MedianMonthlyPayment = median(MonthlyPayment, na.rm = T))
```

>Eligible applicants have lower median monthly payment.  

### 6. Applicants with higher number of dependents have higher income.   
```{r warning=FALSE}
data_preprocessed %>% 
  ggplot(aes(y = ApplicantIncome, x = Dependents, fill = factor(Dependents)))+
  geom_boxplot(alpha = 0.4)
```

```{r}
data_preprocessed %>% 
  filter(Dependents != "") %>% 
  group_by(Dependents) %>% 
  summarise(Count = n(), MedianApplicantIncome = median(ApplicantIncome))
```

>Applicants with 3 or more dependents have the highest median applicant income.  


### 7. How many applicants who are married have dependents?   
```{r}
data_preprocessed %>% 
  filter(Married != "" & Dependents != "") %>% 
  mutate(Dependents = if_else(Dependents > 0, 1,  0)) %>% 
  count(Married, Dependents)
```

```{r}
data_preprocessed %>% 
  filter(Married != "" & Dependents != "") %>% 
  mutate(Dependents = if_else(Dependents > 0, 1,  0)) %>% 
  count(Married, Dependents) %>% 
  ggplot(aes(x = Married, y = n, fill = factor(Dependents)))+
  geom_col()
```

>Majority of married applicants have dependents; however, married applicants who don't have dependents still hold a big percentage. Majority of unmarried applicants don't have dependents.  

```{r}
data_preprocessed %>% 
  filter(Married == "No" & Dependents != "") %>% 
  mutate(Dependents = if_else(Dependents > 0, 1,  0)) %>% 
  count(Married, Dependents) %>% 
  mutate(Percentage = n*100/sum(n))
```

### 8. Loan Amount and Applicant Income  

Cluster the applicant income using kmeans clustering algorithm. The clusters are then labeled: "High Income", "Mid Income", and "Low Income".   
```{r}
ApplicantIncomeCluster <- kmeans(data_preprocessed$ApplicantIncome, 3)
data_preprocessed$ApplicantIncomeCluster <- ApplicantIncomeCluster$cluster

data_preprocessed <- data_preprocessed %>% 
  mutate(ApplicantIncomeCluster = if_else(ApplicantIncomeCluster == 1, "High Income",
                                          if_else(ApplicantIncomeCluster == 2, "Mid Income", "Low Income"))) %>% 
  mutate(ApplicantIncomeCluster = ordered(ApplicantIncomeCluster, levels = c("High Income", "Mid Income", "Low Income")))

```



```{r}
data_preprocessed %>% 
  ggplot(aes(y=ApplicantIncome, x=ApplicantIncomeCluster))+
  geom_boxplot(aes(fill = ApplicantIncomeCluster), alpha = 0.4)
```

The graph below shows that the kmeans algorithm cleanly clustered the applicants income. 

```{r}
data_preprocessed %>% 
  ggplot(aes(x=Loan_ID, y=ApplicantIncome, color = ApplicantIncomeCluster))+
  geom_point(size = 3, alpha = 0.5)+
  theme_void()
```


```{r warning=F}
data_preprocessed %>% 
  ggplot(aes(x = ApplicantIncome, y = LoanAmount, color=ApplicantIncomeCluster))+
  geom_point(alpha = 0.7, size = 3)
```

>Clusters 2 and 3 of applicant income have greater range of loan amount than cluster 1 applicants. 




### 9. Applicants with higher income pay the loan in shorter term
```{r warning=FALSE}
data_preprocessed %>% 
  ggplot(aes(Loan_Amount_Term))+
  geom_density(aes(fill = ApplicantIncomeCluster), alpha =  0.6)
```

>The loan amount term distribution is similar across all applicant income clusters --- peaking at 360 and 180 months.   

### 10. Are most of the applicants with zero co-applicant income unmarried?  
```{r}
data_preprocessed %>% 
  filter(Married != "") %>% 
  mutate(WithCoapplicantIncome = if_else(CoapplicantIncome > 0, 1, 0)) %>% 
  group_by(Married, WithCoapplicantIncome) %>% 
  count() %>% 
  ggplot(aes(x = Married, y = n, fill = factor(WithCoapplicantIncome)))+
  geom_col(position = "dodge", alpha = 0.8)
```

>Most married applicants have co-applicant income and most unmarried applicants don't have co-applicant income.  

### 11. Do male applicants have higher income than female applicants?  
```{r}
data_preprocessed %>% 
  filter(Gender != "") %>% 
  group_by(Gender) %>% 
  summarise(Count = n(), median(ApplicantIncome))
```

```{r}
data_preprocessed %>% 
  filter(Gender != "") %>% 
  ggplot(aes(y=ApplicantIncome, x=Gender, fill = Gender))+
  geom_boxplot(alpha = 0.5)
```

>Apparently, males have slightly higher income than females.  
